
@inject VokimiStorageService vokimiStorageService

@rendermode InteractiveServer

<EditForm Model="@testMainInfo" OnValidSubmit="HandleValidSubmit" FormName="testMainInfoForm">
    <DataAnnotationsValidator />
    <div class="form-content">
        <label for="name" class="form-label">Test name:</label>
        <InputText id="name" class="form-control" @bind-Value="testMainInfo.Name" />



        <label for="description" class="form-label">Test Description (Optional):</label>
        <InputTextArea id="description" class="form-control" @bind-Value="testMainInfo.Description" />



        <div class="cover-choosing-zone">
            <label class="form-label">Test Cover:</label>
            <img class="chosen-cover-viewer" src="@ImgOperationsHelper.ImgUrl(testMainInfo.Cover)" />
            <div class="btns-container">
                <label for="cover" class="change-button">Change</label>
                <div class="remove-btn" @onclick="HandleCoverDelete">Delete</div>
            </div>
            <InputFile id="cover" class="form-control" OnChange="HandleFileChange" accept=".jpg,.png,.webp" hidden />

            <label class="cover-error">@coverUploadingError</label>

        </div>


        <label for="language" class="form-label">Language</label>
        <InputSelect id="language" class="form-control" @bind-Value="testMainInfo.Language">
            @foreach (Language lang in Enum.GetValues(typeof(Language))) {
                <option value="@lang">@lang</option>
            }
        </InputSelect>



        <label for="privacy" class="form-label">Privacy</label>
        <InputSelect id="privacy" class="form-control" @bind-Value="testMainInfo.Privacy">
            @foreach (TestPrivacy privacy in Enum.GetValues(typeof(TestPrivacy))) {
                <option value="@privacy">@privacy</option>
            }
        </InputSelect>


        <button type="submit" class="save-btn">Save</button>
    </div>

</EditForm>
@code {
    private string coverUploadingError = string.Empty;

    [SupplyParameterFromForm]
    public TestMainInfoEditingForm testMainInfo { get; set; } = new();
    [Parameter]
    public DraftGenericTestDto Test { get; set; }

    protected override async Task OnParametersSetAsync() {
        await base.OnParametersSetAsync();
        testMainInfo = TestMainInfoEditingForm.FromTestMainInfoDto(Test.MainInfo);
        if (string.IsNullOrEmpty(testMainInfo.Cover)) {
            testMainInfo.Cover = ImgOperationsHelper.DefaultTestCoverImg;
        }

    }
    private void HandleCoverDelete() =>
        testMainInfo.Cover = ImgOperationsHelper.DefaultTestCoverImg;

    private async Task HandleFileChange(InputFileChangeEventArgs e) {

        var file = e.File;
        int maxAllowedSize = 3145728; /* 3MB */

        if (file != null) {
            if (file.Size > maxAllowedSize) {
                coverUploadingError = $"File is too big. Max allowed size: 3MB";
                return;
            }
            try {
                using (var stream = file.OpenReadStream(maxAllowedSize: maxAllowedSize)) { 
                    var result = await vokimiStorageService.SaveDraftTestCover(Test.Id, stream);
                    result.Switch(
                        path => {
                            testMainInfo.Cover = path;
                            coverUploadingError = string.Empty;
                        },
                        err => coverUploadingError = $"Error uploading cover: {err.Message}"
                    );
                }
            } catch (Exception ex) {
                coverUploadingError = $"Error: {ex.Message}";
            }
        }
    }



    private void HandleValidSubmit() {

    }
}
