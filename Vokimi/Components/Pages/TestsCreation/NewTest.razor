@inject TestsCreationDbOperationsService testsCreationDbOperationsService
@inject UsersDbOperationsService usersDbOperationsService
@inject AuthHelperService authHelperService
@inject NavigationManager navigationManager 

@page "/newtest"
@page "/newtest/{testId}"


<PageTitle>New Test</PageTitle>
<NewTestErrorComponent Message="@pageInitializationError" />

@code {
    [Parameter]
    public string TestId { get; set; } = string.Empty;


    [CascadingParameter]
    public HttpContext httpContext { get; set; }

    private string pageInitializationError = string.Empty;
    private DraftTestId? parsedTestId = null;


    protected override async Task OnInitializedAsync() {

        pageInitializationError = string.Empty;

        if (!Guid.TryParse(TestId, out Guid parsedGuid)) {
            pageInitializationError = "Invalid test ID format.";
            return;
        }
        parsedTestId = new(parsedGuid);

        AppUserId? userId = authHelperService.GetUserIdFromClaims(httpContext.User);
        if (userId is null) {
            pageInitializationError = "An error has occurred. Try to log out of your account and log in again.";
            return;
        }

        AppUser? user = await usersDbOperationsService.GetUserById(userId.Value);
        if (user is null) {
            pageInitializationError = "An error has occurred. Try to log out of your account and log in again.";
            return;
        }
        TestTemplate? type = await testsCreationDbOperationsService.GetTestTypeById(parsedTestId.Value);
        if (type is null) {
            pageInitializationError = "Unknown test";
            return;
        }
        navigationManager.NavigateTo($"/newtest/{type.Value.ShortId()}/{parsedTestId.Value}");

    }
}


