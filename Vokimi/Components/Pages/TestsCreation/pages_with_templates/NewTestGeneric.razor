@inject TestsCreationDbOperationsService testsCreationDbOperationsService
@inject UsersDbOperationsService usersDbOperationsService
@inject AuthHelperService authHelperService
@inject IHttpContextAccessor httpContextAccessor




@rendermode InteractiveServer
@attribute [Authorize]
@page "/newtest/gen/{testId}"

<PageTitle>New Test</PageTitle>



<div class="central-align">
    @if (!string.IsNullOrEmpty(pageInitializationError)) {
        <p>@pageInitializationError</p>
    }

    else if (creator is not null && draftTest is not null) {
        <QuestionEditingDialog @ref="@questionEditingDialog" creatorId="@creator.Id" testId="@draftTest.Id" />
        @switch (pageState) {
            case TestCreationPageState.Overview:
                <TestOverview ChangePageState="ChangePageState"
                              TestDto="new DraftGenericTestDto(draftTest)"
                              NewQuestionAction="()=>{ChangePageState(TestCreationPageState.AllQuestionsOverview);questionEditingDialog.NewQuestion();}"
                              EditQuestionAction="(id)=>{ChangePageState(TestCreationPageState.AllQuestionsOverview);questionEditingDialog.EditQuestion(id);}" />
                break;
            case TestCreationPageState.MainInfoEditing:
                <MainInfoEditing Test="new DraftGenericTestDto(draftTest)"
                                 BackToOverviewAction="()=>ChangePageState(TestCreationPageState.Overview)" />
                break;
            case TestCreationPageState.AllQuestionsOverview:
                <AllQuestionsOverview TestId="@draftTest.Id"
                                      BackToOverviewAction="()=>ChangePageState(TestCreationPageState.Overview)"
                                      EditQuestionAction="questionEditingDialog.EditQuestion"
                                      NewQuestionAction="questionEditingDialog.NewQuestion" />
                break;
            case TestCreationPageState.ResultsCreation:
                <ResultsCreation />
                break;
            case TestCreationPageState.StylesEditing:
                <StylesEditing />
                break;
            case TestCreationPageState.TagsAdding:
                <TagsAdding></TagsAdding>
                break;
            default:
                <h2>default state</h2>
                break;
        }
    }
    else {
        <h2 class="error-occurred">An error has occurred. Try to refresh the page</h2>
    }
</div>

@code {
    [Parameter]
    public string TestId { get; set; } = string.Empty;


    private QuestionEditingDialog questionEditingDialog { get; set; }
    private string pageInitializationError = string.Empty;
    private TestCreationPageState pageState { get; set; } = TestCreationPageState.Overview;
    private DraftTestId? parsedTestId = null;

    public enum TestCreationPageState
    {
        Overview,
        MainInfoEditing,
        AllQuestionsOverview,
        ResultsCreation,
        StylesEditing,
        TagsAdding
    }

    private AppUser creator { get; set; }
    private DraftGenericTest draftTest { get; set; }

    private void ChangePageState(TestCreationPageState newState) {
        pageState = newState;
        StateHasChanged();
    }
    protected override async Task OnInitializedAsync() {

        pageInitializationError = string.Empty;

        if (!Guid.TryParse(TestId, out Guid parsedGuid)) {
            pageInitializationError = "Invalid test ID format.";
            return;
        }
        parsedTestId = new(parsedGuid);

        AppUserId? userId = authHelperService.GetUserIdFromClaims(httpContextAccessor.HttpContext.User);
        if (userId is null) {
            pageInitializationError = "An error has occurred. Try to log out of your account and log in again.";
            return;
        }

        creator = await usersDbOperationsService.GetUserById(userId.Value);
        if (creator is null) {
            pageInitializationError = "An error has occurred. Try to log out of your account and log in again.";
            return;
        }

        draftTest = await testsCreationDbOperationsService.GetTestById<DraftGenericTest>((DraftTestId)parsedTestId, TestTemplate.Generic);
        if (draftTest is null) {
            pageInitializationError = "Unknown test";
            return;
        }
        if (!creator.DraftTests.Contains(draftTest)) {
            pageInitializationError = "You don't have access to this test";
            return;
        }

    }
}
